name: Auto Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README*.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '*.md'

jobs:
  check-for-release:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      release_type: ${{ steps.check.outputs.release_type }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check if release is needed
      id: check
      run: |
        # Get the last commit message
        LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        echo "Last commit: $LAST_COMMIT_MSG"
        
        # Check for conventional commit patterns that should trigger releases
        SHOULD_RELEASE=false
        RELEASE_TYPE="patch"
        
        if echo "$LAST_COMMIT_MSG" | grep -qE "^feat(\(.+\))?!:|^BREAKING CHANGE:|^[a-z]+(\(.+\))?!:"; then
          SHOULD_RELEASE=true
          RELEASE_TYPE="major"
          echo "ðŸš¨ Breaking change detected - major release"
        elif echo "$LAST_COMMIT_MSG" | grep -qE "^feat(\(.+\))?:"; then
          SHOULD_RELEASE=true
          RELEASE_TYPE="minor"
          echo "âœ¨ New feature detected - minor release"
        elif echo "$LAST_COMMIT_MSG" | grep -qE "^fix(\(.+\))?:|^perf(\(.+\))?:"; then
          SHOULD_RELEASE=true
          RELEASE_TYPE="patch"
          echo "ðŸ› Bug fix or performance improvement detected - patch release"
        elif echo "$LAST_COMMIT_MSG" | grep -qE "^(build|ci|docs|style|refactor|test|chore)(\(.+\))?:"; then
          echo "ðŸ“ Non-release commit detected (build/ci/docs/style/refactor/test/chore)"
        else
          echo "â“ Commit doesn't follow conventional commit format, skipping auto-release"
        fi
        
        # Don't auto-release if this is already a version bump commit
        if echo "$LAST_COMMIT_MSG" | grep -qE "^chore: bump version|^v[0-9]+\.[0-9]+\.[0-9]+"; then
          SHOULD_RELEASE=false
          echo "â­ï¸ Skipping auto-release for version bump commit"
        fi
        
        echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
        echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT

  auto-release:
    needs: check-for-release
    if: needs.check-for-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Trigger release workflow
      uses: actions/github-script@v7
      with:
        script: |
          const { data: workflow } = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'release.yml',
            ref: 'main',
            inputs: {
              version_type: '${{ needs.check-for-release.outputs.release_type }}',
              prerelease: 'false',
              draft: 'false'
            }
          });
          
          console.log('ðŸš€ Triggered automatic release workflow');
          console.log(`Release type: ${{ needs.check-for-release.outputs.release_type }}`);